"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var ts = require("typescript");
function flattenAst(sourceFile) {
    return getConvertedAst(sourceFile).flat;
}
exports.flattenAst = flattenAst;
function wrapAst(sourceFile) {
    return getConvertedAst(sourceFile).wrapped;
}
exports.wrapAst = wrapAst;
var CACHE = new WeakMap();
function getConvertedAst(sourceFile) {
    var result = CACHE.get(sourceFile);
    if (result !== undefined)
        return result;
    result = convertAst(sourceFile);
    CACHE.set(sourceFile, result);
    return result;
}
function convertAst(sourceFile) {
    var wrapped = {
        node: sourceFile,
        parent: undefined,
        children: [],
        next: undefined,
        skip: undefined,
    };
    var flat = [];
    var current = wrapped;
    var previous = current;
    ts.forEachChild(sourceFile, function wrap(node) {
        flat.push(node);
        var parent = current;
        previous.next = current = {
            node: node,
            parent: parent,
            children: [],
            next: undefined,
            skip: undefined,
        };
        if (previous !== parent)
            setSkip(previous, current);
        previous = current;
        parent.children.push(current);
        ts.forEachChild(node, wrap);
        current = parent;
    });
    return {
        wrapped: wrapped,
        flat: flat,
    };
}
function setSkip(node, skip) {
    do {
        node.skip = skip;
        node = node.parent;
    } while (node !== skip.parent);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid3JhcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIndyYXAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBaUM7QUFVakMsb0JBQTJCLFVBQXlCO0lBQ2hELE1BQU0sQ0FBQyxlQUFlLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDO0FBQzVDLENBQUM7QUFGRCxnQ0FFQztBQUVELGlCQUF3QixVQUF5QjtJQUM3QyxNQUFNLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQyxDQUFDLE9BQU8sQ0FBQztBQUMvQyxDQUFDO0FBRkQsMEJBRUM7QUFFRCxJQUFNLEtBQUssR0FBRyxJQUFJLE9BQU8sRUFBK0IsQ0FBQztBQU96RCx5QkFBeUIsVUFBeUI7SUFDOUMsSUFBSSxNQUFNLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNuQyxFQUFFLENBQUMsQ0FBQyxNQUFNLEtBQUssU0FBUyxDQUFDO1FBQ3JCLE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFDbEIsTUFBTSxHQUFHLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNoQyxLQUFLLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUM5QixNQUFNLENBQUMsTUFBTSxDQUFDO0FBQ2xCLENBQUM7QUFFRCxvQkFBb0IsVUFBeUI7SUFDekMsSUFBTSxPQUFPLEdBQWE7UUFDdEIsSUFBSSxFQUFFLFVBQVU7UUFDaEIsTUFBTSxFQUFFLFNBQVM7UUFDakIsUUFBUSxFQUFFLEVBQUU7UUFDWixJQUFJLEVBQUUsU0FBUztRQUNmLElBQUksRUFBRSxTQUFTO0tBQ2xCLENBQUM7SUFDRixJQUFNLElBQUksR0FBYyxFQUFFLENBQUM7SUFDM0IsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDO0lBQ3RCLElBQUksUUFBUSxHQUFHLE9BQU8sQ0FBQztJQUN2QixFQUFFLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRSxjQUFjLElBQWE7UUFDbkQsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNoQixJQUFNLE1BQU0sR0FBRyxPQUFPLENBQUM7UUFDdkIsUUFBUSxDQUFDLElBQUksR0FBRyxPQUFPLEdBQUc7WUFDdEIsSUFBSSxNQUFBO1lBQ0osTUFBTSxRQUFBO1lBQ04sUUFBUSxFQUFFLEVBQUU7WUFDWixJQUFJLEVBQUUsU0FBUztZQUNmLElBQUksRUFBRSxTQUFTO1NBQ2xCLENBQUM7UUFDRixFQUFFLENBQUMsQ0FBQyxRQUFRLEtBQUssTUFBTSxDQUFDO1lBQ3BCLE9BQU8sQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFFL0IsUUFBUSxHQUFHLE9BQU8sQ0FBQztRQUNuQixNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUU5QixFQUFFLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUU1QixPQUFPLEdBQUcsTUFBTSxDQUFDO0lBQ3JCLENBQUMsQ0FBQyxDQUFDO0lBRUgsTUFBTSxDQUFDO1FBQ0gsT0FBTyxTQUFBO1FBQ1AsSUFBSSxNQUFBO0tBQ1AsQ0FBQztBQUNOLENBQUM7QUFFRCxpQkFBaUIsSUFBYyxFQUFFLElBQWM7SUFDM0MsR0FBRyxDQUFDO1FBQ0EsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFPLENBQUM7SUFDeEIsQ0FBQyxRQUFRLElBQUksS0FBSyxJQUFJLENBQUMsTUFBTSxFQUFFO0FBQ25DLENBQUMifQ==